syntax = "proto3";

package duraflow;

// Task lifecycle: PENDING → RUNNING → COMPLETED/FAILED/CANCELLED
enum TaskStatus {
    TASK_STATUS_UNSPECIFIED = 0;
    PENDING = 1;
    RUNNING = 2;
    COMPLETED = 3;
    FAILED = 4;
    CANCELLED = 5;
}

message SubmitTaskRequest {
    string workflow_name = 1;
    bytes input = 2;  // JSON-encoded
}

message SubmitTaskResponse {
    string task_id = 1;
}

message GetTaskStatusRequest {
    string task_id = 1;
}

message GetTaskStatusResponse {
    TaskStatus status = 1;
    bytes output = 2;  // JSON-encoded
    bytes error = 3;   // JSON-encoded
}

message CancelTaskRequest {
    string task_id = 1;
}

message CancelTaskResponse {
    bool success = 1;  // False if already completed/failed
}

// Step memoization messages
message GetStepResultRequest {
    string task_id = 1;
    string step_key = 2;
}

message GetStepResultResponse {
    bool found = 1;
    string status = 2;      // 'pending', 'running', 'completed', 'failed'
    bytes output = 3;       // JSON-encoded result (only if completed)
}

message SaveStepResultRequest {
    string task_id = 1;
    string step_key = 2;
    bytes output = 3;       // JSON-encoded result
}

message SaveStepResultResponse {
    string step_id = 1;
}

message FailStepRequest {
    string task_id = 1;
    string step_key = 2;
    string error = 3;
}

message FailStepResponse {}

message CreateStepRequest {
    string task_id = 1;
    string step_key = 2;
}

message CreateStepResponse {
    string step_id = 1;
}

// Task queue management
service AgentService {
    rpc SubmitTask(SubmitTaskRequest) returns (SubmitTaskResponse);
    rpc GetTaskStatus(GetTaskStatusRequest) returns (GetTaskStatusResponse);
    rpc CancelTask(CancelTaskRequest) returns (CancelTaskResponse);
    
    // Step memoization
    rpc GetStepResult(GetStepResultRequest) returns (GetStepResultResponse);
    rpc CreateStep(CreateStepRequest) returns (CreateStepResponse);
    rpc SaveStepResult(SaveStepResultRequest) returns (SaveStepResultResponse);
    rpc FailStep(FailStepRequest) returns (FailStepResponse);
}